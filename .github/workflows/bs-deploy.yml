# Build & Ship ‚Äî auto-deploy on push
# Generated by: bs link
# Docs: https://buildandship.it

name: Build & Ship Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Deploy
        run: |
          echo "üöÄ Triggering Build & Ship deploy..."
          RESPONSE=$(curl -fsSL -w "\n%{http_code}" -X POST "${{ secrets.BS_WEBHOOK_URL }}" \
            -H "X-BS-Token: ${{ secrets.BS_WEBHOOK_SECRET }}" \
            -H "Content-Type: application/json" \
            -d "{\"ref\":\"${{ github.ref }}\",\"sha\":\"${{ github.sha }}\"}" \
            --max-time 300 || true)

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          echo "$BODY"

          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Deploy successful!"
            echo ""
            echo "üîó https://coffee-helm.buildandship.it"
            echo ""
            echo "### üöÄ Deploy Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üîó [https://coffee-helm.buildandship.it](https://coffee-helm.buildandship.it)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Deploy failed (HTTP $HTTP_CODE)"
            exit 1
          fi
